(()=>{"use strict";(()=>{const e=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{let r;switch(o.status){case 200:e(o.response);break;case 400:r="Неверный запрос";break;case 401:r="Пользователь не авторизован";break;case 404:r="Ничего не найдено";break;default:r="Cтатус ответа: : "+o.status+" "+o.statusText}r&&t(r)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o};window.server={load:(t,o)=>{const r=e(t,o);r.open("GET","https://21.javascript.pages.academy/keksobooking/data"),r.send()},update:(t,o,r)=>{const n=e(t,o);n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(r)}}})(),(()=>{const e=["jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=document.querySelectorAll(".ad-form fieldset"),r=t.querySelector("#title"),n=t.querySelector("#type"),a=t.querySelector("#price"),s=t.querySelector("#room_number"),l=t.querySelector("#capacity"),i=t.querySelector("#address"),c=t.querySelector("#timein"),d=t.querySelector("#timeout"),u=t.querySelector("#avatar"),p=t.querySelector(".ad-form-header__preview img"),m=t.querySelector("#images"),y=t.querySelector(".ad-form__photo"),f=document.querySelector("#success").content.querySelector(".success"),v=document.querySelector("#error").content.querySelector(".error");let w=null;const g=(t,o)=>{const r=t.target.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e.result)})),e.readAsDataURL(r)}},h=e=>{p.src=e},S=e=>{y.style.backgroundImage=`url(${e})`,y.style.backgroundSize="contain",y.style.backgroundRepeat="no-repeat",y.style.backgroundPositionX="50%",y.style.backgroundPositionY="50%"},q=()=>{window.map.getIsPageActive()?t.classList.remove("ad-form--disabled"):t.classList.add("ad-form--disabled"),o.forEach((e=>{e.disabled=!window.map.getIsPageActive()}))},_=()=>{let e=r.value.length,t="";e<30?t="Ещё "+(30-e)+" симв.":e>100&&(t="Удалите лишние"+(e-100)+"симв."),r.setCustomValidity(t),r.reportValidity()},b="palace",k="flat",E="house",L="bungalow",x=1e4,A=1e3,C=5e3,D=()=>{const e=n.value;e===L?(a.setAttribute("placeholder","0"),a.setAttribute("min","0")):e===k?(a.setAttribute("placeholder","1000"),a.setAttribute("min","1000")):e===E?(a.setAttribute("placeholder","5000"),a.setAttribute("min","5000")):e===b&&(a.setAttribute("placeholder","10000"),a.setAttribute("min","10000"))},T=()=>{const e=((e,t)=>{let o=!1;return(e===L&&t>=0||e===k&&t>=A||e===E&&t>=C||e===b&&t>=x)&&(o=!0),o})(n.value,parseInt(a.value,10))?"":"Не верная цена";n.setCustomValidity(e)},I=()=>{const e=((e,t)=>{let o=!1;return 1===e&&1===t?o=!0:(2!==e||1!==t&&2!==t)&&(3!==e||1!==t&&2!==t&&3!==t)?100===e&&0===t&&(o=!0):o=!0,o})(parseInt(s.value,10),parseInt(l.value,10)),t=e?"":"Не верное колличество комнат";s.setCustomValidity(t);const o=e?"":"Не верное колличество гостей";l.setCustomValidity(o)},N=e=>{d.value=e},P=e=>{c.value=e};N(c.value);const X=v.cloneNode(!0),z=()=>{w&&(w.remove(),w=null,document.addEventListener("click",F),document.addEventListener("keydown",V))},F=()=>{z()},V=()=>{z()},Y=()=>{document.addEventListener("click",F),document.addEventListener("keydown",V)},$=()=>{w=f.cloneNode(!0),document.querySelector("main").appendChild(w),M(),Y()},j=e=>{w=v.cloneNode(!0),X.querySelector(".error__message").textContent=e,document.querySelector("main").appendChild(w),Y()},M=()=>{window.map.reset(),window.popup.closeCardElement(),h("img/muffin-grey.svg"),y.style.backgroundImage="",t.reset(),window.moving.reset(),t.classList.add("ad-form--disabled"),q()};window.form={changeState:q,initialize:()=>{q(),t.addEventListener("change",(e=>{switch(e.target.id){case s.id:case l.id:I();break;case n.id:T(),D();break;case a.id:T();break;case c.id:N(e.target.value);break;case d.id:P(e.target.value)}t.reportValidity()})),t.addEventListener("submit",(e=>{e.preventDefault(),window.server.update($,j,new FormData(t))})),t.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),M()})),r.addEventListener("input",(()=>{_()})),u.addEventListener("change",(e=>{g(e,h)})),m.addEventListener("change",(e=>{g(e,S)})),I(),T(),t.reportValidity()},setAddres:(e,t)=>{i.value=`${e}, ${t}`},adForm:t}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__filters-container").querySelector(".map__filters"),r=[...o.querySelectorAll("select"),...o.querySelectorAll("fieldset")],n=o.querySelector("#housing-type"),a=o.querySelector("#housing-price"),s=o.querySelector("#housing-rooms"),l=o.querySelector("#housing-guests");let i=[],c=[],d=!1;const u=(t,o)=>{t.addEventListener("click",(()=>{e.appendChild(window.popup.getElement(o))}))},p=()=>{const e=window.filter.getFiltredBookings(c,n.value,a.value,s.value,l.value,Array.from(o.querySelectorAll("#housing-features input:checked")).map((e=>e.value)));m(e)},m=e=>{w(),window.popup.closeCardElement();const o=document.createDocumentFragment();for(let t=0;t<e.length;t++){const r=e[t],n=window.pin.getElement(r);i.push(n),u(n,r),o.appendChild(n)}t.appendChild(o)},y=e=>{c=e,p()},f=()=>{const t=document.createElement("div");t.innerText="Ошибка при попытке загрузки данных",t.style.position="absolute",t.style.width="100%",t.style.height="40px",t.style.textAlign="center",t.style.backgroundColor="#ff000021",t.style.borderWidth="1px",t.style.borderStyle="solid",t.style.borderColor="red",t.style.lineHeight="40px",t.style.top="100px",t.style.color="red",e.appendChild(t)},v=()=>{r.forEach((e=>{e.disabled=!d}))},w=()=>{i.forEach((e=>{e.remove()})),i=[]};window.map={activate:()=>{d||(d=!0,e.classList.remove("map--faded"),v(),window.form.changeState(),window.moving.updateAddress(),window.server.load(y,f))},getIsPageActive:()=>d,mapPins:t,mapFilters:o,reset:()=>{d=!1,v(),e.classList.add("map--faded"),w(),o.reset()},initialize:()=>{v(),o.addEventListener("change",(()=>{window.debounce.listDelay(p())}))}}})(),(()=>{const e="570px",t="375px",o=document.querySelector(".map__pin--main"),r=(e,t)=>({valueX:t+Math.floor(32.5),valueY:e+Math.floor(window.map.getIsPageActive()?87:32.5)}),n=()=>{const{offsetTop:e,offsetLeft:t}=o,n=r(e,t);window.form.setAddres(n.valueX,n.valueY)};window.moving={initialize:()=>{n(),o.addEventListener("keydown",(e=>{"Enter"===e.key&&window.map.activate()})),o.addEventListener("mousedown",(e=>{e.preventDefault(),1===e.which&&window.map.activate();let t={x:e.clientX,y:e.clientY},n=!1;const a=e=>{e.preventDefault(),n=!0;let a=t.x-e.clientX,s=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const l=o.offsetTop-s,i=o.offsetLeft-a,{valueX:c,valueY:d}=r(l,i);c>=0&&c<=1200&&d>=130&&d<=630&&(o.style.top=l+"px",o.style.left=i+"px",window.form.setAddres(c,d))},s=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",s),n){const e=t=>{t.preventDefault(),o.removeEventListener("click",e)};o.addEventListener("click",e)}};document.addEventListener("mousemove",a),document.addEventListener("mouseup",s)}))},updateAddress:n,reset:()=>{o.style.top=t,o.style.left=e,n()}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={getElement:t=>{const o=e.cloneNode(!0),r=o.querySelector("img");return o.style.top=t.location.y+"px",o.style.left=t.location.x+"px",r.setAttribute("src",""+t.author.avatar),r.setAttribute("alt",""+t.offer.title),o}}})(),window.debounce={listDelay:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}}},(()=>{const e="any",t=(t,o)=>o===e||t.offer.type===o,o=(t,o)=>{switch(o){case"middle":return t.offer.price>=1e4&&t.offer.price<=5e4;case"low":return t.offer.price<1e4;case"high":return t.offer.price>5e4;default:return o===e}},r=(t,o)=>o===e||t.offer.rooms===Number(o),n=(t,o)=>o===e||t.offer.guests<=Number(o),a=(e,t)=>t.every((t=>e.offer.features.includes(t)));window.filter={getFiltredBookings:(e,s,l,i,c,d)=>{const u=[];for(let p=0;p<e.length;p++){const m=e[p];if(t(m,s)&&o(m,l)&&r(m,i)&&n(m,c)&&a(m,d)&&u.push(m),5===u.length)break}return u}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};let o=null;const r=()=>{null!==o&&(o.remove(),o=null,document.removeEventListener("keydown",n))},n=e=>{"Escape"===e.key&&r()};window.popup={getElement:a=>{r(),o=e.cloneNode(!0);const s=o.querySelector(".popup__features"),l=o.querySelector(".popup__photos"),i=o.querySelector(".popup__close");return o.querySelector(".popup__title").textContent=""+a.offer.title,o.querySelector(".popup__text--address").textContent=""+a.offer.address,o.querySelector(".popup__text--price").textContent=a.offer.price+" ₽/ночь",o.querySelector(".popup__type").textContent=t[""+a.offer.type],o.querySelector(".popup__text--capacity").textContent=`${a.offer.rooms} комнаты для ${a.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${a.offer.checkin}, выезд до ${a.offer.checkout}`,o.querySelector(".popup__description").textContent=""+a.offer.description,((e,t)=>{e.innerHTML="";for(let o=0;o<t.length;o++){const r=document.createElement("li");r.classList.add("popup__feature","popup__feature--"+t[o]),e.appendChild(r)}})(s,a.offer.features),((e,t)=>{const o=e.querySelector(".popup__photo");e.innerHTML="";for(let r=0;r<t.length;r++){const n=o.cloneNode(!0);n.src=""+t[r],e.appendChild(n)}})(l,a.offer.photos),o.querySelector(".popup__avatar").setAttribute("src",""+a.author.avatar),document.addEventListener("keydown",n),i.addEventListener("click",(()=>{r()})),o},closeCardElement:r}})(),window.map.initialize(),window.moving.initialize(),window.form.initialize()})();