(()=>{"use strict";(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o=(e,t)=>{const o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(()=>{let r;switch(o.status){case 200:e(o.response);break;case 400:r="Неверный запрос";break;case 401:r="Пользователь не авторизован";break;case 404:r="Ничего не найдено";break;default:r="Cтатус ответа: : "+o.status+" "+o.statusText}r&&t(r)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o};window.server={load:(t,r)=>{const n=o(t,r);n.open("GET",e),n.send()},update:(e,r,n)=>{const s=o(e,r);s.open("POST",t),s.send(n)}}})(),(()=>{const e=["jpg","jpeg","png"],t=document.querySelector(".ad-form"),o=document.querySelectorAll(".ad-form fieldset"),r=t.querySelector("#title"),n=t.querySelector("#type"),s=t.querySelector("#price"),a=t.querySelector("#room_number"),l=t.querySelector("#capacity"),i=t.querySelector("#address"),c=t.querySelector("#timein"),d=t.querySelector("#timeout"),u=t.querySelector("#avatar"),p=t.querySelector(".ad-form-header__preview img"),m=t.querySelector("#images"),y=t.querySelector(".ad-form__photo"),v=document.querySelector("#success").content.querySelector(".success"),f=document.querySelector("#error").content.querySelector(".error"),w="palace",g="flat",h="house",S="bungalow",q=1e4,_=1e3,b=5e3;let k=null;const E=(t,o)=>{const r=t.target.files[0],n=r.name.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e.result)})),e.readAsDataURL(r)}},L=e=>{p.src=e},x=e=>{y.style.backgroundImage=`url(${e})`,y.style.backgroundSize="contain",y.style.backgroundRepeat="no-repeat",y.style.backgroundPositionX="50%",y.style.backgroundPositionY="50%"},A=()=>{window.map.getIsPageActive()?t.classList.remove("ad-form--disabled"):t.classList.add("ad-form--disabled"),o.forEach((e=>{e.disabled=!window.map.getIsPageActive()}))},C=()=>{const e=r.value.length;let t="";e<30?t="Ещё "+(30-e)+" симв.":e>100&&(t="Удалите лишние"+(e-100)+"симв."),r.setCustomValidity(t),r.reportValidity()},T=()=>{const e=n.value;e===S?(s.setAttribute("placeholder","0"),s.setAttribute("min","0")):e===g?(s.setAttribute("placeholder","1000"),s.setAttribute("min","1000")):e===h?(s.setAttribute("placeholder","5000"),s.setAttribute("min","5000")):e===w&&(s.setAttribute("placeholder","10000"),s.setAttribute("min","10000"))},D=()=>{const e=((e,t)=>{let o=!0;return(e===S&&t<0||e===g&&t<_||e===h&&t<b||e===w&&t<q)&&(o=!1),o})(n.value,parseInt(s.value,10))?"":"Не верная цена";n.setCustomValidity(e)},I=()=>{const e=((e,t)=>{let o=!1;return 1===e&&1===t?o=!0:(2!==e||1!==t&&2!==t)&&(3!==e||1!==t&&2!==t&&3!==t)?100===e&&0===t&&(o=!0):o=!0,o})(parseInt(a.value,10),parseInt(l.value,10)),t=e?"":"Не верное колличество комнат";a.setCustomValidity(t);const o=e?"":"Не верное колличество гостей";l.setCustomValidity(o)},X=e=>{d.value=e},z=e=>{c.value=e},N=()=>{k&&(k.remove(),k=null,document.removeEventListener("click",P),document.removeEventListener("keydown",V))},P=()=>{N()},V=()=>{N()},Y=()=>{document.addEventListener("click",P),document.addEventListener("keydown",V)},$=()=>{k=v.cloneNode(!0),document.querySelector("main").appendChild(k),F(),Y()},j=()=>{k=f.cloneNode(!0),document.querySelector("main").appendChild(k),Y()},F=()=>{window.map.reset(),window.popup.closeCardElement(),L("img/muffin-grey.svg"),y.style.backgroundImage="",t.reset(),window.moving.reset(),t.classList.add("ad-form--disabled"),A()};window.form={changeState:A,initialize:()=>{A(),t.addEventListener("change",(e=>{switch(e.target.id){case a.id:case l.id:I();break;case n.id:D(),T();break;case s.id:D();break;case c.id:X(e.target.value);break;case d.id:z(e.target.value)}t.reportValidity()})),t.addEventListener("submit",(e=>{e.preventDefault(),window.server.update($,j,new FormData(t))})),t.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),F()})),r.addEventListener("input",(()=>{C()})),u.addEventListener("change",(e=>{E(e,L)})),m.addEventListener("change",(e=>{E(e,x)})),I(),D(),t.reportValidity()},setAddres:(e,t)=>{i.value=`${e}, ${t}`}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=e.querySelector(".map__filters-container").querySelector(".map__filters"),r=[...o.querySelectorAll("select"),...o.querySelectorAll("fieldset")],n=o.querySelector("#housing-type"),s=o.querySelector("#housing-price"),a=o.querySelector("#housing-rooms"),l=o.querySelector("#housing-guests");let i=[],c=[],d=!1;const u=(t,o)=>{t.addEventListener("click",(()=>{e.appendChild(window.popup.getElement(o))}))},p=()=>{const e=window.filter.getFiltredBookings(c,n.value,s.value,a.value,l.value,Array.from(o.querySelectorAll("#housing-features input:checked")).map((e=>e.value)));m(e)},m=e=>{w(),window.popup.closeCardElement();const o=document.createDocumentFragment();for(let t=0;t<e.length;t++){const r=e[t],n=window.pin.getElement(r);i.push(n),u(n,r),o.appendChild(n)}t.appendChild(o)},y=e=>{c=e,p()},v=()=>{const t=document.createElement("div");t.innerText="Ошибка при попытке загрузки данных",t.style.position="absolute",t.style.width="100%",t.style.height="40px",t.style.textAlign="center",t.style.backgroundColor="#ff000021",t.style.borderWidth="1px",t.style.borderStyle="solid",t.style.borderColor="red",t.style.lineHeight="40px",t.style.top="100px",t.style.color="red",e.appendChild(t)},f=()=>{r.forEach((e=>{e.disabled=!d}))},w=()=>{i.forEach((e=>{e.remove()})),i=[]};window.map={activate:()=>{d||(d=!0,e.classList.remove("map--faded"),f(),window.form.changeState(),window.moving.updateAddress(),window.server.load(y,v))},getIsPageActive:()=>d,reset:()=>{d=!1,f(),e.classList.add("map--faded"),w(),o.reset()},initialize:()=>{f(),o.addEventListener("change",window.debounce((()=>{p()})))}}})(),(()=>{const e="570px",t="375px",o=document.querySelector(".map__pin--main"),r=(e,t)=>({valueX:t+Math.floor(32.5),valueY:e+Math.floor(window.map.getIsPageActive()?87:32.5)}),n=()=>{const{offsetTop:e,offsetLeft:t}=o,n=r(e,t);window.form.setAddres(n.valueX,n.valueY)};window.moving={initialize:()=>{n(),o.addEventListener("keydown",(e=>{"Enter"===e.key&&window.map.activate()})),o.addEventListener("mousedown",(e=>{e.preventDefault(),1===e.which&&window.map.activate();let t={x:e.clientX,y:e.clientY},n=!1;const s=e=>{e.preventDefault(),n=!0;let s=t.x-e.clientX,a=t.y-e.clientY;t={x:e.clientX,y:e.clientY};const l=o.offsetTop-a,i=o.offsetLeft-s,{valueX:c,valueY:d}=r(l,i);c>=0&&c<=1200&&d>=130&&d<=630&&(o.style.top=l+"px",o.style.left=i+"px",window.form.setAddres(c,d))},a=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a),n){const e=t=>{t.preventDefault(),o.removeEventListener("click",e)};o.addEventListener("click",e)}};document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)}))},updateAddress:n,reset:()=>{o.style.top=t,o.style.left=e,n()}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={getElement:t=>{const{location:{x:o,y:r},author:{avatar:n},offer:{title:s}}=t,a=e.cloneNode(!0),l=a.querySelector("img");return a.style.top=r+"px",a.style.left=o+"px",l.setAttribute("src",""+n),l.setAttribute("alt",""+s),a}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),300)}},(()=>{const e="any",t=(t,o)=>o===e||t.offer.type===o,o=(t,o)=>{switch(o){case"middle":return t.offer.price>=1e4&&t.offer.price<=5e4;case"low":return t.offer.price<1e4;case"high":return t.offer.price>5e4;default:return o===e}},r=(t,o)=>o===e||t.offer.rooms===Number(o),n=(t,o)=>o===e||t.offer.guests<=Number(o),s=(e,t)=>t.every((t=>e.offer.features.includes(t)));window.filter={getFiltredBookings:(e,a,l,i,c,d)=>{const u=[];for(let p=0;p<e.length;p++){const m=e[p];if(t(m,a)&&o(m,l)&&r(m,i)&&n(m,c)&&s(m,d)&&u.push(m),5===u.length)break}return u}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};let o=null;const r=()=>{null!==o&&(o.remove(),o=null,document.removeEventListener("keydown",n))},n=e=>{"Escape"===e.key&&r()};window.popup={getElement:s=>{const{offer:{title:a,address:l,price:i,type:c,rooms:d,guests:u,checkin:p,checkout:m,description:y,features:v,photos:f},author:{avatar:w}}=s;r(),o=e.cloneNode(!0);const g=o.querySelector(".popup__features"),h=o.querySelector(".popup__photos"),S=o.querySelector(".popup__close");return o.querySelector(".popup__title").textContent=""+a,o.querySelector(".popup__text--address").textContent=""+l,o.querySelector(".popup__text--price").textContent=i+" ₽/ночь",o.querySelector(".popup__type").textContent=t[""+c],o.querySelector(".popup__text--capacity").textContent=`${d} комнаты для ${u} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${p}, выезд до ${m}`,o.querySelector(".popup__description").textContent=""+y,((e,t)=>{e.innerHTML="";for(let o=0;o<t.length;o++){const r=document.createElement("li");r.classList.add("popup__feature","popup__feature--"+t[o]),e.appendChild(r)}})(g,v),((e,t)=>{const o=e.querySelector(".popup__photo");e.innerHTML="";for(let r=0;r<t.length;r++){const n=o.cloneNode(!0);n.src=""+t[r],e.appendChild(n)}})(h,f),o.querySelector(".popup__avatar").setAttribute("src",""+w),document.addEventListener("keydown",n),S.addEventListener("click",(()=>{r()})),o},closeCardElement:r}})(),window.map.initialize(),window.moving.initialize(),window.form.initialize()})();